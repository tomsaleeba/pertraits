name: Continuous Deployment

on:
  push:
    branches:
      - 'main'
      - 'develop'

jobs:
  lint-and-test:
    runs-on: ubuntu-latest
    steps:

    - uses: actions/checkout@v2
    # ubuntu-latest already comes with aws-cli
    # https://github.com/actions/virtual-environments/blob/main/images/linux/Ubuntu2004-Readme.md#cli-tools

    - name: configure AWS CLI
      run: |
        aws configure <<-EOF > /dev/null 2>&1
        ${AWS_ACCESS_KEY_ID:?}
        ${AWS_SECRET_ACCESS_KEY:?}
        ${AWS_REGION:?}
        text
        EOF

    - name: Install dependencies
      run: |
        cd ./frontend/
        npm ci

    - name: build
      run: |
        cd ./frontend/
        npm run build

    - name: deploy
      run: |
        cd frontend/build/
        branchName=${GITHUB_REF##*/}
        bucket=${AWS_S3_BUCKET:?}
        if [ $branchName = 'develop' ]; then
          bucket="dev.${bucket}"
        fi
        aws s3 sync --delete . s3://${bucket}
